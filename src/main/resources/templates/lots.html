<!--
  lots.html — Lot listing and search page.

  Supports:
    • AC2  — Fuzzy search for lots by ID.
    • AC1  — Cross-referenced data shown in the table.
    • AC3  — Shipping status column ("Shipped" / "In Inventory").
    • AC4  — Production line column.
    • AC9  — Source file/row shown for traceability.

  Thymeleaf model attributes:
    ${lots}            — List<LotDetailDTO>
    ${searchPerformed} — boolean, true after a search was submitted
    ${searchQuery}     — the raw search string entered by the user
    ${noResults}       — boolean, true if search found nothing
-->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/layout :: head('Lot Lookup — Steelworks Tracker')}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<nav th:replace="~{fragments/layout :: navbar}"></nav>

<main class="container">

    <h1 class="mb-4">Lot Lookup</h1>

    <!-- ═══════════════════════════════════════════════════════════
         SEARCH BOX (AC2: Fuzzy Matching)
         The form submits a GET request to /lots/search?query=...
         ═══════════════════════════════════════════════════════════ -->
    <form th:action="@{/lots/search}" method="get" class="mb-4">
        <div class="input-group search-box">
            <input type="text" name="query" class="form-control"
                   placeholder="Enter Lot ID (e.g., LOT-123 or LOT123)..."
                   th:value="${searchQuery}"/>
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
        <small class="form-text text-muted">
            Supports fuzzy matching: "LOT-123", "LOT 123", and "LOT123" all match the same lot (AC2).
        </small>
    </form>

    <!-- No-results message -->
    <div th:if="${noResults}" class="alert alert-warning">
        No lot found matching "<span th:text="${searchQuery}">???</span>".
        The ID may not exist in any data source.
    </div>

    <!-- ═══════════════════════════════════════════════════════════
         LOT TABLE (AC1, AC3, AC4, AC9)
         ═══════════════════════════════════════════════════════════ -->
    <div th:if="${not #lists.isEmpty(lots)}">
        <table class="table table-hover table-striped">
            <thead class="table-dark">
            <tr>
                <th>Lot ID</th>
                <th>Part Number</th>
                <th>Shipping Status (AC3)</th>
                <th>Production Line (AC4)</th>
                <th>Defect Summary</th>
                <th>Source (AC9)</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="lot : ${lots}">
                <td>
                    <!-- Link to the detailed view -->
                    <a th:href="@{/lots/{id}(id=${lot.lotIdentifier})}"
                       th:text="${lot.lotIdentifier}">LOT-001</a>
                </td>
                <td th:text="${lot.partNumber}">SKU-100</td>
                <td>
                    <!-- AC3: Colour-coded shipping status -->
                    <span class="badge"
                          th:classappend="${lot.shippingStatus == 'Shipped'} ? 'bg-success' : 'bg-secondary'"
                          th:text="${lot.shippingStatus}">Shipped</span>
                </td>
                <td>
                    <!-- AC4 + AC11: Show production line; warn if conflict -->
                    <span th:if="${lot.productionLine.startsWith('Multiple')}"
                          class="text-danger fw-bold"
                          th:text="${lot.productionLine}">Multiple (Conflict)</span>
                    <span th:unless="${lot.productionLine.startsWith('Multiple')}"
                          th:text="${lot.productionLine}">Line 1</span>
                </td>
                <td th:text="${lot.defectSummary}">None</td>
                <td class="source-info">
                    <!-- AC9: Source transparency — show origin file and row -->
                    <span th:if="${lot.sourceFile != null}"
                          th:text="${lot.sourceFile + ' (Row ' + lot.sourceRowNumber + ')'}">
                        data.csv (Row 42)
                    </span>
                    <span th:unless="${lot.sourceFile != null}" class="text-muted">N/A</span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- Empty state when no lots exist at all -->
    <div th:if="${#lists.isEmpty(lots) and not noResults}" class="text-muted">
        No lots found in the system.
    </div>

</main>

<footer th:replace="~{fragments/layout :: footer}"></footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
